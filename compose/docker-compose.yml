services:
  file-processing:
    image: etl-file-processing
    build:
      context: ../
      dockerfile: ../packages/file_processing/file-processing.Dockerfile
    volumes:
      - ../packages/file_processing:/app/packages/file_processing
      - ../packages/etl_core:/app/packages/etl_core

  data-pipeline:
    image: etl-data-pipeline
    build:
      context: ../
      dockerfile: ../packages/data_pipeline/data-pipeline.Dockerfile
    volumes:
      - ../packages/data_pipeline:/app/packages/data_pipeline
      - ../packages/etl_core:/app/packages/etl_core

  observability-api:
    image: etl-observability
    build:
      context: ../
      dockerfile: ../packages/observability/observability.Dockerfile
    volumes:
      - ../packages/observability:/app/packages/observability
      - ../packages/etl_core:/app/packages/etl_core
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/postgres
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET:-}
      - SLACK_SHARED_CHANNEL_ID=${SLACK_SHARED_CHANNEL_ID:-}
      - APP_BASE_URL=http://localhost:8000
      - INTERNAL_INGEST_TOKEN=${INTERNAL_INGEST_TOKEN:-changeme}
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - redis
    command: ["python", "-m", "observability.server"]

  observability-worker:
    image: etl-observability
    build:
      context: ../
      dockerfile: ../packages/observability/observability.Dockerfile
    volumes:
      - ../packages/observability:/app/packages/observability
      - ../packages/etl_core:/app/packages/etl_core
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/postgres
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET:-}
      - SLACK_SHARED_CHANNEL_ID=${SLACK_SHARED_CHANNEL_ID:-}
      - APP_BASE_URL=http://localhost:8000
      - INTERNAL_INGEST_TOKEN=${INTERNAL_INGEST_TOKEN:-changeme}
    depends_on:
      - postgres
      - redis
    command: ["python", "-m", "observability.worker", "--interval-minutes", "15"]

  postgres:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"

  redis:
    image: redis:7
    ports:
      - "6379:6379"
