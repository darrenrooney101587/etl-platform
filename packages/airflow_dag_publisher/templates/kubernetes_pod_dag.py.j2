"""
{{ description }}

This DAG is generated by CI and published to S3. It executes the {{ package_name }}
job using KubernetesPodOperator.

Generated at: {{ timestamp }}
Package: {{ package_name }}
Image: {{ image_tag }}
"""
from datetime import datetime, timedelta

from airflow import DAG
from airflow.providers.cncf.kubernetes.operators.kubernetes_pod import (
    KubernetesPodOperator,
)
from kubernetes.client import models as k8s


# Default arguments for all tasks in this DAG
default_args = {
    "owner": "{{ package_name }}",
    "depends_on_past": False,
    "email_on_failure": {{ email_on_failure }},
    "email_on_retry": False,
    "retries": {{ retries }},
    "retry_delay": timedelta(minutes={{ retry_delay_minutes }}),
    "execution_timeout": timedelta(minutes={{ execution_timeout_minutes }}),
}

# DAG definition
with DAG(
    dag_id="{{ dag_id }}",
    default_args=default_args,
    description="{{ description }}",
    schedule_interval="{{ schedule_interval }}",
    start_date=datetime({{ start_year }}, {{ start_month }}, {{ start_day }}),
    catchup={{ catchup }},
    tags={{ tags }},
    max_active_runs={{ max_active_runs }},
) as dag:

    # Job execution using KubernetesPodOperator
    run_job = KubernetesPodOperator(
        task_id="{{ task_id }}",
        name="{{ task_id.replace('_', '-') }}",
        namespace="{{ kubernetes_namespace }}",
        image="{{ image_tag }}",
        image_pull_policy="{{ image_pull_policy }}",
        cmds={{ cmds }},
        arguments={{ arguments }},
        env_vars={{ env_vars }},
        # Resource limits
        container_resources=k8s.V1ResourceRequirements(
            requests={
                "cpu": "{{ cpu_request }}",
                "memory": "{{ memory_request }}",
            },
            limits={
                "cpu": "{{ cpu_limit }}",
                "memory": "{{ memory_limit }}",
            },
        ),
        # Service account for IRSA
        service_account_name="{{ service_account_name }}",
        # Logging
        get_logs=True,
        log_events_on_failure=True,
        # Cleanup
        is_delete_operator_pod=True,
        # Security context
        security_context={
            "runAsNonRoot": True,
            "runAsUser": 1000,
            "fsGroup": 1000,
        },
        # Restart policy
        restart_policy="Never",
    )
